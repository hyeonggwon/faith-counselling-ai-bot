### 장로교 교리 기반 AI 신앙상담 챗봇

- 개발 배경

> 저는 현재 장로교 교회를 다니는 청년인데, 삶을 살아가는데에 있어 신앙인의 관점에서 상담해줄 수 있는 사람이 많지 않습니다. 또한 사소한 것 하나하나 다들 성도분들께 물어보기도 눈치가 보입니다.
시중에 나와있는 AI 챗봇과 상담하기엔 Hallucination 확률이 높고, 세상에는 다양한 종교가 있기 때문에 제가 신앙하고 있는 장로교 교리 기반으로 답변을 받기가 어렵습니다.
이러한 문제를 해결하기 위해, 장로교 교리 기반으로 답변을 해주는 AI 챗봇을 만들기로 하였습니다.
> 
- 기술 스택
    - 언어 : `Python`
    - RAG 프레임워크 : `Langchain`
- 구현 방법
    - 데이터 수집
        
        우선 아래와 같은 장로교 교리 데이터를 수집하였습니다.
        
        1. `웨스트민스터 신앙고백서`
        2. `소요리문답`
        3. `대요리문답`
        4. `하이델베르크 요리문답` 
        
        위의 데이터들은 인터넷에서 쉽게 구할 수 있으며, `txt` 파일로 데이터를 수집하였습니다.
        
    - 벡터 DB 구성
        
        `Langchain`을 활용하여 교리 데이터를 chunk별로 나누었고, 임베딩 모델은 `BAAI/bge-m3` 를 사용하였습니다. (한국어 검색을 위한 임베딩 벤치마크 : https://github.com/teddylee777/Kor-IR?tab=readme-ov-file 참고하여 모델을 선택했습니다.) `FAISS`를 활용하여 벡터 DB를 구성하였습니다.
        
    - Retriever 검색
        
        `FAISS`를 이용해 만든 벡터 DB의 `as_retriever`를 활용해 `base_retriever`를 만들었고, 리랭커를 사용하여 검색 정확도를 높였습니다. 리랭커 모델은 `BAAI/bge-reranker-v2-m3` 을 사용하였는데, LLM 기반 리랭커라 기존의 리랭커보다 질문과 문서 간의 관계를 훨씬 더 잘 파악할 수 있기 때문에 사용하였습니다. `base_retriever`와 리랭커를 결합하여 `ContextualCompressionRetriever` 객체를 만들어 `retriever`로 활용하였습니다.
        
    - Prompt 구성
        
        ```python
        """
        당신은 웨스트민스터 신앙고백과 대소요리문답에 해박한 장로교 교리 전문가입니다. 주어진 문서를 바탕으로 다음 질문에 대해 신학적으로 답변해주세요.\n\n
        [질문] : {question}\n\n
        [문서] : {document}\n\n
        """
        ```
        
        위와 같은 프롬프트를 구성하여, AI에게 페르소나를 부여하여 답변의 퀄리티를 높였습니다.
        
    - LLM
        
        `Langchain` 을 활용하여 LLM을 생성했고, 모델은 무료 모델인`gemini-1.5-flash-latest` 을 사용하였습니다.
        
    - Chain 생성
        
        Prompt와 LLM을 결합하여 Chain을 생성하였습니다.
        
    - ask() 함수 구현
        
        사용자가 질문을 하면, `retriever.invoke()` 를 통해 질문의 내용과 유사도가 높은 문서들을 가져옵니다. 그 문서들을 하나로 합쳐 프롬프트의 `document`에 넣고, 질문은 `question`에 넣어서 Chain을 통해 질문을 하도록 구현하였습니다. 또한 실시간으로 토큰이 출력되도록 하기 위해, `chain.stream()` 을 사용하였습니다.
        
- 실행 결과
    
    ```python
    RAG 초기화 중... 잠시만 기다려주세요
    당신의 신앙을 도와주는 AI입니다. 무엇이 궁금하신가요?
    질문(q or quit to exit) : 예수님을 왜 믿어야 하나요?
    
    예수님을 믿어야 하는 이유는, 웨스트민스터 신앙고백과 대소요리문답에 따르면 다음과 같습니다.
    결론적으로, 예수님은 우리의 유일한 구원자이시며,
    그분을 믿는 것이 영원한 생명을 얻는 유일한 길이기 때문입니다.이는 다음과 같은 여러 측면에서 확인됩니다.
    
    **1. 인간의 죄와 멸망에서의 구원:**
    
    문서 29, 30절은 예수님을 "구주(救主)"라 부르는 이유를 명확히 합니다.
    인간은 아담의 범죄로 인해 죄의 삯인 사망에 처해 있습니다 (로마서 6:23).
    우리는 스스로 죄에서 벗어날 수 없으며, 어떤 성인이나 자기 노력으로도 구원을 얻을 수 없습니다(문서 30절).
    오직 예수 그리스도만이 우리를 죄에서 구원하실 수 있으며, 그분 외에는 구원의 길이 없습니다.
    예수님은 우리의 대속물이 되시어 십자가에서 우리의 죄값을 치르셨습니다 (문서 31절).
    이는 문서 20절에서도 언급된 바와 같이, 아담 안에서 모든 사람이 멸망한 것처럼 그리스도를 통하여
    모든 사람이 구원받는 것이 아니라, 그리스도에게 참된 믿음으로 연합된 자들만 구원받는다는 것을 시사합니다.
    
    **2. 하나님의 약속과 은혜의 완성:**
    
    문서 19절은 구원의 역사가 낙원에서부터 시작되어 율법과 예언을 통해 예표되고,
    마침내 예수 그리스도를 통해 완성되었음을 보여줍니다.  예수님은 하나님의 약속의 완성이시며,
    하나님의 구원 계획의 중심이십니다.  문서 21절은 참된 믿음의 본질을 설명하는데,
    그것은 단순히 지식이 아니라 하나님의 은혜로 인한 확신과 신뢰입니다.
    우리는 예수 그리스도의 공로로 말미암아 죄 사함과 의롭게 됨, 그리고 영원한 생명을 얻습니다.
    이것은 하나님의 전적인 은혜에 근거한 것입니다.
    
    **3. 그리스도의 삼중직분:**
    
    문서 31절은 예수 그리스도의 삼중 직분(선지자, 제사장, 왕)을 강조합니다.
    예수님은 선지자로서 하나님의 뜻을 계시하시고, 제사장으로서 우리의 죄를 대속하시며, 왕으로서 우리를 다스리고 보호하십니다.
    이 삼중 직분은 예수님이 우리의 구원에 필요한 모든 것을 완벽하게 제공하신다는 것을 보여줍니다.
    우리는 그분의 가르침을 통해 진리를 알고, 그분의 희생으로 죄 사함을 받으며,
    그분의 통치 아래서 안전과 평안을 누립니다.
    
    **4.  믿음의 성장과 확신:**
    
    문서 1절과 3절은 믿음의 성장과 흔들림에 대해 언급합니다.
    믿음은 성령의 역사와 말씀의 봉사를 통해 자라나며, 때로는 시험을 받고 약해질 수도 있지만,
    결국 승리하게 됩니다. 이는 우리의 믿음이 완벽하지 않더라도, 예수님을 향한 믿음을 굳게 붙잡는 것이
    중요함을 보여줍니다.  문서 2절은 믿음의 행위를 강조합니다.
    우리는 말씀에 순종하고, 하나님의 약속을 기뻐하며, 그리스도를 의지해야 합니다.
    
    요약하자면, 예수님을 믿어야 하는 이유는 그분이 우리의 유일한 구원자이시기 때문입니다.
    그분은 우리의 죄를 대속하시고, 하나님과의 화목을 회복시켜 주시며, 영원한 생명을 약속하십니다.
    이는 하나님의 전적인 은혜와 약속에 근거한 것이며, 우리의 믿음을 통해 받아들여지는 것입니다.
    사도신경 (문서 23절)에 요약된 내용처럼,
    예수 그리스도의 삶, 죽음, 부활, 재림에 대한 믿음이 바로 우리의 구원의 근거가 됩니다.
    ```
